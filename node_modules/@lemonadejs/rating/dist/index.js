if (!lemonade && typeof (require) === 'function') {
    var lemonade = require('lemonadejs');
}

;(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define(factory) :
    global.Rating = factory();
}(this, (function () {

    class CustomEvents extends Event {
        constructor(type, props, options) {
            super(type, {
                bubbles: true,
                composed: true,
                ...options,
            });

            if (props) {
                for (const key in props) {
                    // Avoid assigning if property already exists anywhere on `this`
                    if (! (key in this)) {
                        this[key] = props[key];
                    }
                }
            }
        }
    }

    // Dispatcher
    const Dispatch = function(method, type, options) {
        // Try calling the method directly if provided
        if (typeof method === 'function') {
            let a = Object.values(options);
            return method(...a);
        } else if (this.tagName) {
            this.dispatchEvent(new CustomEvents(type, options));
        }
    }

    const Rating = function(children, { onchange, onload }) {
        let self = this;

        // Event
        let change = self.onchange;
        self.onchange = null;

        if (! self.number) {
            self.number = 5;
        }

        self.stars = [];

        // Current self star
        let current = null;

        /**
         * Update the number of stars
         */
        const len = function () {
            // Remove stars
            if (self.number < self.stars.length) {
                self.stars.splice(self.number, self.stars.length);
                if (self.value > self.number) {
                    self.value = self.number;
                }
            }
            // Add missing stars
            for (let i = 0; i < self.number; i++) {
                if (! self.stars[i]) {
                    self.stars[i] = {
                        icon: 'star',
                    };
                    if (self.tooltip[i]) {
                        self.stars[i].title = self.tooltip[i];
                    }
                }
            }
            // Refresh
            self.refresh('stars');
        }

        const val = function (index, events) {
            if (typeof(index) === 'string') {
                index = Number(index);
            }
            // Apply value to the selected property in each star
            for (let i = 0; i < self.number; i++) {
                self.stars[i].selected = i <= index - 1 ? 1 : 0;
            }
            // Keep current value
            current = index;
            // Dispatch method
            if (events !== false) {
                Dispatch.call(self, change, 'change', {
                    instance: self,
                    value: index,
                });
            }
        }

        const getElementPosition = function(child) {
            if (child.tagName === 'I') {
                let root = self.el;
                for (let i = 0; i < root.children.length; i++) {
                    let c = root.children[i];
                    if (c === child) {
                        return i;
                    }
                }
            }
            return -1;
        }

        const click = function(e, s) {
            let ret = getElementPosition(e.target);
            if (ret !== -1) {
                let index = ret + 1;
                if (index === current) {
                    index = 0;
                }
                self.value = index;
            }
        }

        const mouseover = function(e, s) {
            let index = getElementPosition(e.target);
            if (index !== -1) {
                for (let i = 0; i < self.number; i++) {
                    if (i <= index) {
                        self.stars[i].hover = 1;
                    } else {
                        self.stars[i].hover = 0;
                    }
                }
            }
        }

        const mouseout = function(e, s) {
            for (let i = 0; i < self.number; i++) {
                self.stars[i].hover = 0;
            }
        }

        onchange((prop) => {
            if (prop === 'number') {
                len();
            } else if (prop === 'value') {
                val(self.value);
            } else if (prop === 'tooltip') {
                if (typeof(self.tooltip) === 'string') {
                    self.tooltip = self.tooltip.split(',')
                }
                len();
            }
        })

        onload(() => {
            // Bind global method to be compatible with LemonadeJS forms
            self.el.val = function (v) {
                if (typeof (v) === 'undefined') {
                    return self.value;
                } else {
                    self.value = v;
                }
            }

            if (self.tooltip && typeof(self.tooltip) === 'string') {
                self.tooltip = self.tooltip.split(',')
            } else {
                self.tooltip = '';
            }
            len();
            // Ignore events
            val(self.value, false);

            self.el.addEventListener('click', click);
            self.el.addEventListener('mouseout', mouseout);
            self.el.addEventListener('mouseover', mouseover);
        });

        self.getValue = function () {
            return Number(self.value);
        }

        self.setValue = function (index) {
            self.value = index;
        }

        return `<div class="lm-rating" value="{{self.value}}" number="{{self.number}}" name="{{self.name}}" data-size="{{self.size}}" :loop="self.stars">
            <i class="material-symbols-outlined material-icons" data-selected="{{self.selected}}" data-hover="{{self.hover}}" title="{{self.title}}">star</i>
        </div>`;
    }

    // Register the LemonadeJS Component
    lemonade.setComponents({ Rating: Rating });
    // Register the web component
    lemonade.createWebComponent('rating', Rating);

    return function (root, options) {
        if (typeof (root) === 'object') {
            lemonade.render(Rating, root, options)
            return options;
        } else {
            return Rating.call(this, root)
        }
    }

})));